<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Production Intel Dashboard</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=JetBrains+Mono&display=swap');

    body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
    .font-mono { font-family: 'JetBrains Mono', monospace; }

    .custom-scrollbar::-webkit-scrollbar { width: 4px; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #1e293b; border-radius: 10px; }

    @keyframes softPulse {
      0%,100% { transform: scale(1); opacity: .55; }
      50% { transform: scale(1.35); opacity: 1; }
    }
    .pulse-dot {
      animation: softPulse 1.2s infinite ease-in-out;
      box-shadow: 0 0 0.6rem currentColor;
    }
  </style>
</head>

<body class="bg-slate-950 text-slate-100 min-h-screen p-4">
<div class="max-w-7xl mx-auto">

<header class="flex flex-col md:flex-row justify-between items-start mb-8 gap-4">
  <div>
    <h1 class="text-3xl font-black flex items-center gap-2 tracking-tight">
      <i data-lucide="monitor" class="text-blue-500"></i> PRODUCTION INTEL
    </h1>
    <p id="clock" class="text-slate-400 text-[10px] font-mono uppercase tracking-widest">--:--:--</p>
  </div>

  <button onclick="resetData()" class="bg-slate-900 border border-slate-800 px-3 py-1.5 rounded-lg text-red-400 text-[10px] font-bold uppercase">
    Reset All Machines
  </button>
</header>

<div id="machine-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>

</div>

<script>
/* -------------------- DATA -------------------- */
const allLengths = ["15\"", "18\"", "21\"", "23\"", "24\"", "30\"", "33\""];

const defaultSchedule = {
  run2ndShift: true,
  thirdShiftMode: "normal",
  allowSundayNightThird: false
};

let machines = JSON.parse(localStorage.getItem("prod_intel_v4")) || [
  { id:1,name:"Red Machine",color:"#ef4444",speed:0,target:0,efficiency:90,shifts:["1st","3rd"],currentLength:"23\"",allowedLengths:["23\""],queue:[],status:"idle",...defaultSchedule },
  { id:2,name:"Orange Machine",color:"#f97316",speed:0,target:0,efficiency:90,shifts:["1st","3rd"],currentLength:"33\"",allowedLengths:["33\"","21\"","18\""],queue:[],status:"idle",...defaultSchedule },
  { id:3,name:"Yellow Machine",color:"#eab308",speed:0,target:0,efficiency:90,shifts:["1st","3rd"],currentLength:"23\"",allowedLengths:["15\"","18\"","21\"","23\""],queue:[],status:"idle",...defaultSchedule },
  { id:4,name:"Green Machine",color:"#22c55e",speed:0,target:0,efficiency:90,shifts:["1st","3rd"],currentLength:"15\"",allowedLengths:allLengths,queue:[],status:"idle",...defaultSchedule },
  { id:5,name:"Blue Machine",color:"#3b82f6",speed:0,target:0,efficiency:90,shifts:["1st","3rd"],currentLength:"15\"",allowedLengths:allLengths,queue:[],status:"idle",...defaultSchedule },
];

machines = machines.map(m => ({ ...defaultSchedule, ...m }));

const saveData = () => localStorage.setItem("prod_intel_v4", JSON.stringify(machines));
const resetData = () => confirm("Clear all data?") && localStorage.removeItem("prod_intel_v4") && location.reload();

/* -------------------- HELPERS -------------------- */
const isProducing = m =>
  m.status === "active" && m.speed > 0 && m.target > 0;

const inWindow = (h,s,e) => s<=e ? h>=s && h<e : h>=s || h<e;

function isTimeInActiveShift(date,m){
  const h=date.getHours()+date.getMinutes()/60;
  const d=date.getDay();
  if(d===6) return false;
  if(d===0 && !m.allowSundayNightThird) return false;

  const in1 = m.shifts.includes("1st") && inWindow(h,6.5,16.5);
  const in2 = m.run2ndShift && m.shifts.includes("2nd") && inWindow(h,16.5,20.5);
  const [s,e] = m.thirdShiftMode==="early" ? [16.5,3] : [20.5,6.5];
  const in3 = m.shifts.includes("3rd") && inWindow(h,s,e);

  return d===0 ? in3 : in1||in2||in3;
}

/* -------------------- METRICS -------------------- */
function calculateMetrics(m){
  const bph=(m.speed*60/1000)*(m.efficiency/100);
  const cur=(bph&&m.target)?(m.target/bph)*60:0;

  let seq=[{mins:cur,bph,type:"job"}];
  m.queue.forEach(q=>{
    const qb=(q.speed*60/1000)*(m.efficiency/100);
    seq.push({mins:q.changeOver||0,type:"co"});
    seq.push({mins:(qb&&q.target)?(q.target/qb)*60:0,bph:qb,type:"job"});
  });

  let total=seq.reduce((a,s)=>a+s.mins,0);
  let cd=new Date(),rem=total;
  while(rem>0){ if(isTimeInActiveShift(cd,m)) rem--; cd.setMinutes(cd.getMinutes()+1); }

  let next=null;
  if(m.queue.length && cur){
    let nd=new Date(),nr=cur+(m.queue[0].changeOver||0);
    while(nr>0){ if(isTimeInActiveShift(nd,m)) nr--; nd.setMinutes(nd.getMinutes()+1); }
    const s=Math.max(0,Math.floor((nd-Date.now())/1000));
    next=[Math.floor(s/3600),Math.floor(s%3600/60),s%60].map(x=>String(x).padStart(2,"0")).join(":");
  }

  return {
    finish: total?cd.toLocaleString([],{weekday:"short",hour:"numeric",minute:"2-digit"}):"N/A",
    duration:`${Math.floor(total/60)}h ${Math.round(total%60)}m`,
    next
  };
}

/* -------------------- ACTIONS -------------------- */
const update=(id,f,v)=>{ const m=machines.find(x=>x.id===id); m[f]=isNaN(m[f])?v:+v||0; saveData(); render(); };
const toggleShift=(id,s)=>{ const m=machines.find(x=>x.id===id); m.shifts=m.shifts.includes(s)?m.shifts.filter(x=>x!==s):[...m.shifts,s]; saveData(); render(); };
const addQueue=id=>{ machines.find(m=>m.id===id).queue.push({id:Date.now(),changeOver:0,speed:0,target:0,length:""}); saveData(); render(); };
const updateQueue=(m,q,f,v)=>{ const x=machines.find(x=>x.id===m).queue.find(y=>y.id===q); x[f]=f==="length"?v:+v||0; saveData(); render(); };
const removeQueue=(m,q)=>{ machines.find(x=>x.id===m).queue=machines.find(x=>x.id===m).queue.filter(y=>y.id!==q); saveData(); render(); };

/* -------------------- RENDER -------------------- */
function render(){
  document.getElementById("machine-grid").innerHTML=machines.map(m=>{
    const r=calculateMetrics(m);
    return `
<div class="bg-slate-900 border-2 rounded-2xl p-4" style="border-color:${isProducing(m)?m.color:"#1e293b"}">
<div class="flex justify-between mb-2">
  <div class="flex items-center gap-2 font-black uppercase">${m.name}
    ${isProducing(m)?`<span class="pulse-dot w-2 h-2 rounded-full" style="background:${m.color};color:${m.color}"></span>`:`<span class="w-2 h-2 bg-slate-600 rounded-full"></span>`}
  </div>
  <select onchange="update(${m.id},'status',this.value)" class="bg-transparent text-xs">
    <option ${m.status==="active"?"selected":""}>active</option>
    <option ${m.status==="idle"?"selected":""}>idle</option>
  </select>
</div>

<div class="text-xs text-slate-400">Next Job</div>
<div class="text-2xl font-black text-emerald-400">${r.next||"--:--:--"}</div>

<div class="mt-2 text-xs text-slate-500">Finish: ${r.finish}</div>
<div class="text-xs text-slate-500">Runtime: ${r.duration}</div>
</div>`;
  }).join("");
  lucide.createIcons();
}

setInterval(()=>document.getElementById("clock").textContent=new Date().toLocaleTimeString(),1000);
render();
</script>
</body>
</html>
